---
- name: Install and Configure Starship
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    nerd_font_version: "v3.4.0"
    font_dir_linux: "/usr/share/fonts/truetype/jetbrains-mono-nerd"
    font_dir_macos: "{{ ansible_env.HOME }}/Library/Fonts"

  tasks:
    # Install Starship using the official installer with auto-confirm
    - name: Install Starship
      ansible.builtin.shell: |
        curl -sS https://starship.rs/install.sh | sh -s -- -y
      args:
        creates: /usr/local/bin/starship

    # Font installation for Linux
    - name: Install unzip (Linux)
      ansible.builtin.package:
        name: unzip
        state: present
      when: ansible_system == "Linux"

    - name: Ensure fonts directory exists (Linux)
      ansible.builtin.file:
        path: "{{ font_dir_linux }}"
        state: directory
        mode: "0755"
      when: ansible_system == "Linux"

    - name: Download Nerd Font (Linux)
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/download/{{ nerd_font_version }}/JetBrainsMono.zip"
        dest: /tmp/JetBrainsMono.zip
        mode: "0644"
      when: ansible_system == "Linux"

    - name: Unzip Nerd Font (Linux)
      ansible.builtin.unarchive:
        src: /tmp/JetBrainsMono.zip
        dest: "{{ font_dir_linux }}"
        remote_src: true
      when: ansible_system == "Linux"

    - name: Install fontconfig (Linux)
      ansible.builtin.package:
        name: fontconfig
        state: present
      when: ansible_system == "Linux"

    - name: Refresh font cache (Linux)
      ansible.builtin.command: fc-cache -f -v
      when: ansible_system == "Linux"

    - name: Clean up Nerd Font zip (Linux)
      ansible.builtin.file:
        path: /tmp/JetBrainsMono.zip
        state: absent
      when: ansible_system == "Linux"

    # Font installation for macOS
    - name: Ensure fonts directory exists (macOS)
      ansible.builtin.file:
        path: "{{ font_dir_macos }}"
        state: directory
        mode: "0755"
      become: false
      when: ansible_system == "Darwin"

    - name: Download Nerd Font (macOS)
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/download/{{ nerd_font_version }}/JetBrainsMono.zip"
        dest: /tmp/JetBrainsMono.zip
        mode: "0644"
      when: ansible_system == "Darwin"

    - name: Create temp directory for font extraction (macOS)
      ansible.builtin.file:
        path: /tmp/JetBrainsMono
        state: directory
        mode: "0755"
      when: ansible_system == "Darwin"

    - name: Unzip Nerd Font (macOS)
      ansible.builtin.unarchive:
        src: /tmp/JetBrainsMono.zip
        dest: /tmp/JetBrainsMono
        remote_src: true
      when: ansible_system == "Darwin"

    - name: Find Nerd Font ttf files (macOS)
      ansible.builtin.find:
        paths: /tmp/JetBrainsMono
        patterns: "*.ttf"
      register: font_files
      when: ansible_system == "Darwin"

    - name: Copy fonts to user fonts directory (macOS)
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ font_dir_macos }}/"
        mode: "0644"
        remote_src: true
      loop: "{{ font_files.files }}"
      become: false
      when: ansible_system == "Darwin"

    - name: Clean up temp files (macOS)
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/JetBrainsMono.zip
        - /tmp/JetBrainsMono
      when: ansible_system == "Darwin"
